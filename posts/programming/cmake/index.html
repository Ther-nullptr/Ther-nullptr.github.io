<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Makefile &amp; CMake :: Ther&#39;s Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="清华大学电子工程系软件部暑培。" />
<meta name="keywords" content="programming" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://ther-nullptr.github.io/posts/programming/cmake/" />




<link rel="stylesheet" href="https://ther-nullptr.github.io/assets/style.css">

  <link rel="stylesheet" href="assets/%25!s%28%3cnil%3e%29.css">






<link rel="apple-touch-icon" href="https://ther-nullptr.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://ther-nullptr.github.io/">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Makefile &amp; CMake">
<meta property="og:description" content="清华大学电子工程系软件部暑培。" />
<meta property="og:url" content="https://ther-nullptr.github.io/posts/programming/cmake/" />
<meta property="og:site_name" content="Ther&#39;s Blog" />

  
    <meta property="og:image" content="https://ther-nullptr.github.io/">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

  <meta property="article:section" content="programming" />


  <meta property="article:published_time" content="2022-06-23 20:47:58 &#43;0800 CST" />












</head>
<body class="">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://ther-nullptr.github.io/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/posts/">Home</a></li>
        
      
        
          <li><a href="/about/">About</a></li>
        
      
        
          <li><a href="/archives/">Archives</a></li>
        
      
        
          <li><a href="/search/">Search</a></li>
        
      
        
          <li><a href="/links/">Links</a></li>
        
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/posts/">Home</a></li>
      
    
      
        <li><a href="/about/">About</a></li>
      
    
      
        <li><a href="/archives/">Archives</a></li>
      
    
      
        <li><a href="/search/">Search</a></li>
      
    
      
        <li><a href="/links/">Links</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://ther-nullptr.github.io/posts/programming/cmake/">Makefile &amp; CMake</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-06-23
        
      </span>
    
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://ther-nullptr.github.io/tags/c&#43;&#43;/">C&#43;&#43;</a>&nbsp;
    
    #<a href="https://ther-nullptr.github.io/tags/summer-training/">summer training</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="makefile--cmake">Makefile &amp; CMake<a href="#makefile--cmake" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>想象一下我们有如下C++程序<code>hello.cpp</code>：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;hello world!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们需要在终端输入以下指令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ g++ hello.cpp -o hello 
</span></span></code></pre></td></tr></table>
</div>
</div><p>这时我们就可以生成可执行文件<code>hello</code>。但在实际应用场景中，我们可能会面临如下问题：</p>
<ul>
<li>项目中的<code>.h</code>文件和<code>.cpp</code>文件十分繁多。</li>
<li>各<code>.h</code>文件、<code>.cpp</code>文件的依赖关系十分复杂。</li>
<li>多文件可能会出现重复编译的情况，拖慢编译速度。</li>
<li>&hellip;</li>
</ul>
<p>为了解决这些问题，<code>makefile</code>和<code>CMake</code>应运而生。</p>
<p>本讲需要使用到的工具：<code>g++</code>，<code>make</code>，<code>cmake</code>。可以通过以下方式安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt-get install g++ make cmake
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="makefile">Makefile<a href="#makefile" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>makefile文件描述了C/C++工程的编译规则，可以用来指明源文件的编译顺序、依赖关系、是否需要重新编译等，自动化编译C/C++项目（实际上也不止局限于C/C++项目）。</p>
<p>我们可以考虑以下实例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── invsqrt.cpp
</span></span><span class="line"><span class="cl">├── invsqrt.h
</span></span><span class="line"><span class="cl">├── main.cpp
</span></span><span class="line"><span class="cl">└── makefile
</span></span></code></pre></td></tr></table>
</div>
</div><p>makefile如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-makefile" data-lang="makefile"><span class="line"><span class="cl"><span class="nv">CXXFLAGS</span> <span class="o">=</span> -std<span class="o">=</span>c++17 -O2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="o">:</span> <span class="n">main</span>.<span class="n">o</span> <span class="n">invsqrt</span>.<span class="n">o</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>CXX<span class="k">)</span> <span class="k">$(</span>CXXFLAGS<span class="k">)</span> -o <span class="nv">$@</span> $^  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">main.o</span><span class="o">:</span> <span class="n">main</span>.<span class="n">cpp</span> <span class="n">invsqrt</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>CXX<span class="k">)</span> <span class="k">$(</span>CXXFLAGS<span class="k">)</span> -o <span class="nv">$@</span> -c $&lt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">invsqrt.o</span><span class="o">:</span> <span class="n">invsqrt</span>.<span class="n">cpp</span> <span class="n">invsqrt</span>.<span class="n">h</span>
</span></span><span class="line"><span class="cl">	<span class="k">$(</span>CXX<span class="k">)</span> <span class="k">$(</span>CXXFLAGS<span class="k">)</span> -o <span class="nv">$@</span> -c $&lt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">clean</span>
</span></span><span class="line"><span class="cl"><span class="nf">clean</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	rm main.o invsqrt.o main
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们不需要理解每一段代码的具体含义（之后我们可以看到，我们不需要手动编写makefile，而可以直接通过CMake工具生成makefile），我们只需要了解如何使用makefile：</p>
<ul>
<li>在makefile的同目录下输入<code>make</code>，就可以按照makefile所指定的编译规则自动编译整个工程。</li>
<li>在makefile的同目录下输入<code>make clean</code>，可以删除编译生成的中间文件和可执行文件。</li>
<li>除此之外，你还可以为makefile添加更多指令，此处由于篇幅所限，不再展开介绍。</li>
</ul>
<h2 id="cmake">CMake<a href="#cmake" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>makefile存在以下问题：</p>
<ul>
<li>语法复杂，代码可读性差，难以维护。</li>
<li>跨平台性差。</li>
</ul>
<p>在目前的C++工程中，我们多使用CMake来管理项目。</p>
<p>什么是<a href="https://cmake.org/">CMake</a>？CMake是一种跨平台的编译工具，可以用较为简洁易读的语法描述C++项目的编译、链接、安装过程等，在现代C++项目上得到了广泛应用。</p>
<h3 id="1-第一个cmake项目">1 第一个CMake项目<a href="#1-第一个cmake项目" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>CMake的项目文件叫做<code>CMakeLists.txt</code>。其放置位置如下图所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">├── CMakeLists.txt
</span></span><span class="line"><span class="cl">└── main.cpp
</span></span></code></pre></td></tr></table>
</div>
</div><p>该项目的<code>CMakeLists.txt</code>中需要添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span> <span class="p">(</span><span class="s">hello_world</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">hello_world</span> <span class="s">main.cpp</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>语法总结1</strong></p>
<ul>
<li><code>cmake_minimum_required(VERSION 3.5)</code> CMake需要的最小版本。CMake的版本可以在命令行中输入<code>cmake --version</code>获取，一般无强制要求。</li>
<li><code>project(&lt;project_name&gt;)</code> 指定工程名称。</li>
<li><code>add_executable(&lt;executable_name&gt; &lt;cppfile_name&gt;)</code> 生成可执行文件。</li>
</ul>
</blockquote>
<p>cmake工具的使用一般分为两步 1) 使用<code>CMakeLists.txt</code>生成<code>makefile</code>。 2) 使用<code>makefile</code>自动化编译项目。</p>
<ol>
<li>输入<code>cmake CMakeLists.txt</code>，目录下将会生成一个<code>Makefile</code>文件。</li>
<li>输入<code>make</code>，即可将源代码编译生成可执行文件。此处将会在与<code>CMakeLists.txt</code>相同目录的位置生成一个可执行文件<code>hello_word</code>，输入<code>./hello_word</code>即可运行该可执行文件。</li>
<li>此外，输入<code>make help</code>，你也可以查看使用当前的<code>Makefile</code>所能执行的所有指令，例如<code>make clean</code>（清楚生成的可执行文件和中间文件）。</li>
</ol>
<h3 id="2-多文件">2 多文件<a href="#2-多文件" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>在平时的程设小作业中，我们习惯将所有的代码都写在一个<code>.cpp</code>文件中。但在实际工程中，为了方便代码复用和运行维护，通常将所有的文件划分为头文件(<code>.h</code>)，模块文件(<code>.cpp</code>)和主程序文件(<code>.cpp</code>)。</p>
<p>在本节中，我们将在头文件中声明一个计算平方根倒数的函数，在模块文件中实现其主体，然后在主函数中调用它。项目结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── CMakeLists.txt
</span></span><span class="line"><span class="cl">├── include
</span></span><span class="line"><span class="cl">│   └── invsqrt.h
</span></span><span class="line"><span class="cl">└── src
</span></span><span class="line"><span class="cl">    ├── invsqrt.cpp
</span></span><span class="line"><span class="cl">    └── main.cpp
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>tips: 在C++工程中，我们通常在<code>include/</code>目录下放置头文件，在<code>src/</code>目录下放置源文件。</p>
</blockquote>
<p>该项目的<code>CMakeLists.txt</code>中需要添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="c"># build part
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">invsqrt</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SOURCES</span> <span class="s">src/invsqrt.cpp</span> <span class="s">src/main.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">invsqrt</span> <span class="o">${</span><span class="nv">SOURCES</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">invsqrt</span> <span class="s">PUBLIC</span> <span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/include</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># debug part
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">message</span><span class="p">(</span><span class="s2">&#34;CMAKE_SOURCE_DIR: ${CMAKE_SOURCE_DIR}&#34;</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">message</span><span class="p">(</span><span class="s2">&#34;PROJECT_SOURCE_DIR: ${PROJECT_SOURCE_DIR}&#34;</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">message</span><span class="p">(</span><span class="s2">&#34;SOURCES: ${SOURCES}&#34;</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>语法总结2</strong></p>
<ul>
<li><code>set(&lt;variable&gt; &lt;value&gt;)</code> 设置变量</li>
<li><code>target_include_directories(&lt;project_name&gt; &lt;INTERFACE|PUBLIC|PRIVATE&gt; &lt;headfile_directory&gt;)</code> 指定所要包含的头文件。</li>
<li><code>message(&quot;your message&quot;)</code> 在终端打印信息。</li>
</ul>
</blockquote>
<p>这里需要特别说明一下CMake中的变量使用。CMake中的变量分为两种：</p>
<ul>
<li>显式变量：使用<code>set</code>指令定义的变量。</li>
<li>隐式变量：通过其它指令隐式生成的变量。如该项目中会隐式生成<code>PROJECT_SOURCE_DIR</code>变量，默认为<code>CMakeLists.txt</code>所在的文件夹。</li>
</ul>
<p>CMake中有丰富的变量，用于定义工程目录、编译选项等，此处不做过多展开。想要了解更多，可以参考文末列出的参考文档。</p>
<h3 id="3-静态库和动态库">3 静态库和动态库<a href="#3-静态库和动态库" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>有些时候，出于方便复用、防止源码泄露等原因，我们需要将代码封装为静态库和动态库。CMake同样提供了生成静态库和动态库的功能。</p>
<h4 id="31-静态库">3.1 静态库<a href="#31-静态库" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>在此处，我们将上一小节中计算平方根倒数的程序封装为静态库。项目结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── CMakeLists.txt
</span></span><span class="line"><span class="cl">├── include
</span></span><span class="line"><span class="cl">│   └── invsqrt.h
</span></span><span class="line"><span class="cl">└── src
</span></span><span class="line"><span class="cl">    ├── invsqrt.cpp
</span></span><span class="line"><span class="cl">    └── main.cpp
</span></span></code></pre></td></tr></table>
</div>
</div><p>该项目的<code>CMakeLists.txt</code>中需要添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">invsqrt</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># create static library
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">add_library</span><span class="p">(</span><span class="s">invsqrt_static</span> <span class="s">STATIC</span> <span class="s">src/invsqrt.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">invsqrt_static</span> <span class="s">PUBLIC</span> <span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/include</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># create executable
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">invsqrt</span> <span class="s">src/main.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">invsqrt</span> <span class="s">PRIVATE</span> <span class="s">invsqrt_static</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>语法总结3</strong></p>
<ul>
<li><code>add_library(&lt;library_name&gt; STATIC &lt;cppfile_name&gt;)</code> 生成静态库</li>
<li><code>target_link_libraries(&lt;executable&gt; &lt;INTERFACE|PUBLIC|PRIVATE&gt; &lt;library_name&gt;)</code> 指定所要链接的库。</li>
</ul>
</blockquote>
<p>此处我们使用一种更为优雅的生成方式——我们期望将生成的静态库、可执行文件输出到<code>build</code>文件夹里，而不是和主项目混杂在一起。为此我们需要输入以下指令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ mkdir build
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">$ cmake .. <span class="c1"># 使用的是上一层目录的CMakeLists.txt，因此需要输入&#39;..&#39;</span>
</span></span><span class="line"><span class="cl">$ make
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们将会在<code>build/</code>目录下看到静态库<code>libinvsqrt_static.a</code>和可执行文件<code>invsqrt</code>。</p>
<h4 id="32-动态库">3.2 动态库<a href="#32-动态库" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p>项目目录结构同静态库一节。</p>
<p>该项目的<code>CMakeLists.txt</code>中需要添加以下内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.5</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">invsqrt</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># create shared library
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">add_library</span><span class="p">(</span><span class="s">invsqrt_shared</span> <span class="s">SHARED</span> <span class="s">src/invsqrt.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_include_directories</span><span class="p">(</span><span class="s">invsqrt_shared</span> <span class="s">PUBLIC</span> <span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/include</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="c"># create executable
</span></span></span><span class="line"><span class="cl"><span class="c"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">invsqrt</span> <span class="s">src/main.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">invsqrt</span> <span class="s">PRIVATE</span> <span class="s">invsqrt_shared</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>语法总结4</strong></p>
<ul>
<li><code>add_library(&lt;library_name&gt; SHARED &lt;cppfile_name&gt;)</code> 生成动态库</li>
</ul>
</blockquote>
<p>同样按照上小节的方法生成项目。我们将会在<code>build/</code>目录下看到动态库<code>libinvsqrt_shared.so</code>和可执行文件<code>invsqrt</code>。</p>
<h3 id="4-使用第三方库">4 使用第三方库<a href="#4-使用第三方库" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>在实际的C++工程中，我们可能需要链接一些开源的第三方库。CMake也提供了相关的配置方式。我们以谷歌开发的单元测试框架<code>googletest</code>为例：</p>
<blockquote>
<p>googletest的安装方法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ git clone https://github.com/google/googletest.git
</span></span><span class="line"><span class="cl"><span class="c1"># or git clone git@github.com:google/googletest.git</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> googletest
</span></span><span class="line"><span class="cl">$ mkdir build 
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> build
</span></span><span class="line"><span class="cl">$ cmake ../
</span></span><span class="line"><span class="cl">$ make -j all
</span></span><span class="line"><span class="cl">$ make install 
</span></span><span class="line"><span class="cl"><span class="c1"># or sudo make install</span>
</span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<blockquote>
<p>在默认情况下，与该第三方库相关的头文件将会被放置在<code>/usr/local/include</code>目录下，与该第三方库相关的库文件将会被放置在<code>/usr/local/lib</code>目录下，与该第三方库相关的可执行文件将会被放置在<code>/usr/local/bin</code>目录下。</p>
</blockquote>
<p>项目结构如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">.
</span></span><span class="line"><span class="cl">├── CMakeLists.txt
</span></span><span class="line"><span class="cl">├── include
</span></span><span class="line"><span class="cl">│   └── mysqrt.h
</span></span><span class="line"><span class="cl">└── src
</span></span><span class="line"><span class="cl">    ├── mysqrt.cpp
</span></span><span class="line"><span class="cl">    └── main.cpp
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cmake" data-lang="cmake"><span class="line"><span class="cl"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">2.6</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">project</span><span class="p">(</span><span class="s">cmake_with_gtest</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">set</span><span class="p">(</span><span class="s">SOURCES</span> <span class="s">src/mysqrt.cpp</span> <span class="s">src/main.cpp</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">find_package</span><span class="p">(</span><span class="s">GTest</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">message</span><span class="p">(</span><span class="s2">&#34;GTEST_LIBRARIES: ${GTEST_LIBRARIES}&#34;</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">message</span><span class="p">(</span><span class="s2">&#34;GTEST_INCLUDE_DIRS: ${GTEST_INCLUDE_DIRS}&#34;</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">include_directories</span><span class="p">(</span><span class="o">${</span><span class="nv">GTEST_INCLUDE_DIRS</span><span class="o">}</span> <span class="o">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="o">}</span><span class="s">/include</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">add_executable</span><span class="p">(</span><span class="s">cmake_with_gtest</span> <span class="o">${</span><span class="nv">SOURCES</span><span class="o">}</span><span class="p">)</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="nb">target_link_libraries</span><span class="p">(</span><span class="s">cmake_with_gtest</span> <span class="o">${</span><span class="nv">GTEST_LIBRARIES</span><span class="o">}</span> <span class="s">pthread</span><span class="p">)</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><strong>语法总结5</strong></p>
<ul>
<li><code>find_package(&lt;package_name&gt;)</code> 查询第三方库的位置。若查找成功，则初始化变量<code>&lt;package_name&gt;_INCLUDE_DIR</code>（第三方库的头文件目录）以及<code>&lt;package_name&gt;_LIBRARIES</code>（第三方库的静态/动态库目录）。</li>
</ul>
</blockquote>
<p>CMake支持的所有第三方库可以在<a href="https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html">https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html</a>中找到。</p>
<h2 id="写在最后">写在最后<a href="#写在最后" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>CMake还有很多强大的功能：</p>
<ul>
<li>设置C++工程的语言标准、编译优化选项。</li>
<li>层级文件之间<code>CMakeLists.txt</code>的相互调用，以便应用于目录层级更加复杂的C++工程。</li>
<li>对生成的库、可执行文件等进行安装。</li>
<li>&hellip;</li>
</ul>
<p>略过上述内容不会对我们的教学产生太大影响。感兴趣的同学可以参考以下文章：</p>
<ul>
<li><a href="https://cmake.org/documentation/">CMake官方文档</a></li>
<li><a href="https://github.com/ttroy50/cmake-examples">cmake-examples</a> 该GitHub仓库中有很多开箱即用的CMake实例。</li>
<li><a href="https://www.zhihu.com/question/461953861/answer/1914452432">为什么编译c/c++要用makefile，而不是直接用shell呢？</a> 这篇博文详细地阐述了使用makefile的动机和意义（\xfgg/）。</li>
<li><a href="https://seisman.github.io/how-to-write-makefile/introduction.html">跟我一起写Makefile</a> Makefile教程。从中大家也可以看出Makefile的语法十分不友好&hellip;</li>
</ul>

      </div></div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://ther-nullptr.github.io/assets/main.js"></script>
<script src="https://ther-nullptr.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
